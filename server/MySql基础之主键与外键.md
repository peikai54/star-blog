## MySql 之主键与外键

### 什么是主键？为什么不要用业务字段设置主键？

**主键是 MySql 表中用于保证数据唯一性的字段，它是唯一的。每个主键值能正确对应上表中唯一的一条数据。** 主键这东西跟身份证号码一样，每个号码只能对应一个人，这样当我们进行增删查改的操作时，才能确信通过主键寻找到正确的数据。

在日常开发中应该尽量确保每张表都设置一个主键。并且**建议使用自增字段设置主键，避免使用业务相关的字段设置主键。**因为业务的变化，底层数据的建模不是我们能预料的，而主键要求非空值且不可重复。虽然某些业务上的部分字段现阶段看起来满足主键要求，但未来业务调整后，若是该字段不再满足要求，那会对应用产生很大影响。

例如，我们有一张用户表，假设我们使用用户的身份证号码作为用户表主键，按道理说身份证号码满足非空 + 唯一性需求。但如果业务在未来进行调整，例如允许用户不实名登录，也就是部分用户可能不需要提供身份证号码，这种场景下用户表数据的身份证号码便不再满足主键要求。而随着业务的发展，数据越来越多，表结构表关系也越来越复杂，这种修改恐怕会牵一发而动全身，很容易引出新的 bug。

因此不管什么场景，个人都建议使用自增字段作为表结构主键 。

#### 但是使用自增字段设置主键一定是安全的吗？

在大部分情况的单机系统来，这个做法是没问题的。但在复杂系统分库里，这样并不安全。举个例子，一个商场记录用户信息，用户要求把增加新会员的工作放到门店进行，因为发展新会员的工作一般是在门店进行的，毕竟，人们一般都是在购物的同时申请会员。解决的办法是，门店的信息系统添加新增会员的功能，把新的会员信息先存放到本地 MySQL 数据库中，再上传到总部，进行汇总。可是问题来了，如果会员信息表的主键是自增的，那么各个门店新加的会员就会出现“id”冲突的可能。

这时，我们可以使用手动赋值的方式进行主键自增。具体操作是：在总部 MySQL 数据库中，有一个管理信息表，里面的信息包括成本核算策略，支付方式等，还有总部的系统参数，我们可以在这个表中添加一个字段，专门用来记录当前会员编号的最大值。

### 什么是外键 ? 为什么要设置外键 ?

假设我们有 2 个表，分别是表 A 和表 B，它们通过一个公共字段“id”发生关联关系，我们把这个关联关系叫做 R。如果“id”在表 A 中是主键，那么，表 A 就是这个关系 R 中的主表。相应的，表 B 就是这个关系中的从表，表 B 中的“id”，就是表 B 用来引用表 A 中数据的，叫外键。**所以，外键就是从表中用来引用主表中数据的那个公共字段**。

**那么为什么要设置外键呢？**

因为外键能保证数据的一致性和完整性。举个例子：现在我们要用 MySql 来存储班级和学生的数据。首先我们需要一张班级表，班级表包含人数、位置、年级等信息。然后我们添加一个自增的 id 作为主键。

```sql
CREATE TABLE `class` (
  `id` int NOT NULL AUTO_INCREMENT,
  `class` int DEFAULT NULL,
  `grader` int DEFAULT NULL,
  `student_count` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

现在我们需要一张学生表。学生表自然也会存储学生姓名、年龄、性别等信息，但同时我们还需要存储一个信息：学生在哪个班级。假设这个字段名叫 class。按道理来说，每个学生都从属于一个班级，因此用 class 字段和班级表的 id 关联，把 class 设置成外键是理所当然的。

```sql
CREATE TABLE `student` (
  `id` int NOT NULL AUTO_INCREMENT,
  `class` int DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `age` int DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `belong_class` (`class`),
  CONSTRAINT `belong_class` FOREIGN KEY (`class`) REFERENCES `class` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

**但如果我们不设置外键会怎么样？**

假设现在有这样的情况: 一个班级解散了，那么班级表上的班级 A 的数据自然要删除。这时如果程序员对表关系不熟悉，忘了处理学生表，那么当你查询学生表时，就会出现这种状况：很多学生来自一个已经不存在的班级。这便导致了数据的错误。

设置了外键的好处就在这里。当班级数据被删除时，MySql 会自动去查询学生表上是否存在和该班级 id 关联的数据，如果存在就会报错，无法删除。也就是说，你不能在学生还在的时候解散这个班，正确的操作是先录入正确的学生数据，例如这个班的学生解散后都去了哪个班，或者毕业了数据被删除，最后才去删掉班级数据。

这种数据的统一性往往需要在 MySql 表结构和程序代码上共同维护，降低风险。
